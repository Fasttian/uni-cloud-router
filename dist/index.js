"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("fs"),t=require("path"),r=require("events");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=n(e),o=n(t);function s(e,t){return e(t={exports:{}},t.exports),t.exports}var a=s((function(e,t){!function(r){const n=Function.prototype.toString;function i(e){if("function"!=typeof e)return!1;if(/^class[\s{]/.test(n.call(e)))return!0;const t=function(e){return n.call(e).replace(/^[^{]*{\s*/,"").replace(/\s*}[^}]*$/,"")}(e);return/classCallCheck\(/.test(t)||/TypeError\("Cannot call a class as a function"\)/.test(t)}e.exports&&(t=e.exports=i),t.isClass=i}()})),u=(a.isClass,s((function(e){const t={};e.exports=function(r="./",...n){const s=new Map,u={};return s.set(u,{path:o.default.isAbsolute(r)?o.default.join(r,"./"):o.default.join(o.default.dirname(e.parent.filename),r,"./"),is_class:!1}),function e(r){return new Proxy(r,{get:(r,o)=>{if(o in r||"symbol"==typeof o||"inspect"==o)return r[o];const u=s.get(r);if(u.is_class)return u.instance||(u.instance=new r(...n)),u.instance[o]?u.instance[o]:"$map"==o?u:u.instance[o];if("$map"==o)return u;let f={};const c=u.path+o+"/",l=u.path+o+".js";if(t[c]||((e=>i.default.existsSync(e)&&i.default.statSync(e).isFile())(l)?t[c]="file":(e=>i.default.existsSync(e)&&i.default.statSync(e).isDirectory())(c)?t[c]="dir":t[c]="none"),"file"==t[c])f=require(l);else if("dir"!=t[c])return;return s.set(f,{path:c,is_class:a(f)}),r[o]=e(f),r[o]},set:(e,t,r)=>{if(t in e)return e[t]=r,!0;const i=s.get(e);return i.is_class?(i.instance||(i.instance=new e(...n)),i.instance[t]=r,!0):(e[t]=r,!0)}})}(u)}})));function f(e,t){void 0===t&&(t={});for(var r=function(e){for(var t=[],r=0;r<e.length;){var n=e[r];if("*"!==n&&"+"!==n&&"?"!==n)if("\\"!==n)if("{"!==n)if("}"!==n)if(":"!==n)if("("!==n)t.push({type:"CHAR",index:r,value:e[r++]});else{var i=1,o="";if("?"===e[a=r+1])throw new TypeError('Pattern cannot start with "?" at '+a);for(;a<e.length;)if("\\"!==e[a]){if(")"===e[a]){if(0==--i){a++;break}}else if("("===e[a]&&(i++,"?"!==e[a+1]))throw new TypeError("Capturing groups are not allowed at "+a);o+=e[a++]}else o+=e[a++]+e[a++];if(i)throw new TypeError("Unbalanced pattern at "+r);if(!o)throw new TypeError("Missing pattern at "+r);t.push({type:"PATTERN",index:r,value:o}),r=a}else{for(var s="",a=r+1;a<e.length;){var u=e.charCodeAt(a);if(!(u>=48&&u<=57||u>=65&&u<=90||u>=97&&u<=122||95===u))break;s+=e[a++]}if(!s)throw new TypeError("Missing parameter name at "+r);t.push({type:"NAME",index:r,value:s}),r=a}else t.push({type:"CLOSE",index:r,value:e[r++]});else t.push({type:"OPEN",index:r,value:e[r++]});else t.push({type:"ESCAPED_CHAR",index:r++,value:e[r++]});else t.push({type:"MODIFIER",index:r,value:e[r++]})}return t.push({type:"END",index:r,value:""}),t}(e),n=t.prefixes,i=void 0===n?"./":n,o="[^"+c(t.delimiter||"/#?")+"]+?",s=[],a=0,u=0,f="",l=function(e){if(u<r.length&&r[u].type===e)return r[u++].value},p=function(e){var t=l(e);if(void 0!==t)return t;var n=r[u],i=n.type,o=n.index;throw new TypeError("Unexpected "+i+" at "+o+", expected "+e)},d=function(){for(var e,t="";e=l("CHAR")||l("ESCAPED_CHAR");)t+=e;return t};u<r.length;){var h=l("CHAR"),v=l("NAME"),y=l("PATTERN");if(v||y){var w=h||"";-1===i.indexOf(w)&&(f+=w,w=""),f&&(s.push(f),f=""),s.push({name:v||a++,prefix:w,suffix:"",pattern:y||o,modifier:l("MODIFIER")||""})}else{var m=h||l("ESCAPED_CHAR");if(m)f+=m;else if(f&&(s.push(f),f=""),l("OPEN")){w=d();var x=l("NAME")||"",E=l("PATTERN")||"",g=d();p("CLOSE"),s.push({name:x||(E?a++:""),pattern:x&&!E?o:E,prefix:w,suffix:g,modifier:l("MODIFIER")||""})}else p("END")}}return s}function c(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function l(e){return e&&e.sensitive?"":"i"}function p(e,t,r){return function(e,t,r){void 0===r&&(r={});for(var n=r.strict,i=void 0!==n&&n,o=r.start,s=void 0===o||o,a=r.end,u=void 0===a||a,f=r.encode,p=void 0===f?function(e){return e}:f,d="["+c(r.endsWith||"")+"]|$",h="["+c(r.delimiter||"/#?")+"]",v=s?"^":"",y=0,w=e;y<w.length;y++){var m=w[y];if("string"==typeof m)v+=c(p(m));else{var x=c(p(m.prefix)),E=c(p(m.suffix));if(m.pattern)if(t&&t.push(m),x||E)if("+"===m.modifier||"*"===m.modifier){var g="*"===m.modifier?"?":"";v+="(?:"+x+"((?:"+m.pattern+")(?:"+E+x+"(?:"+m.pattern+"))*)"+E+")"+g}else v+="(?:"+x+"("+m.pattern+")"+E+")"+m.modifier;else v+="("+m.pattern+")"+m.modifier;else v+="(?:"+x+E+")"+m.modifier}}if(u)i||(v+=h+"?"),v+=r.endsWith?"(?="+d+")":"$";else{var b=e[e.length-1],A="string"==typeof b?h.indexOf(b[b.length-1])>-1:void 0===b;i||(v+="(?:"+h+"(?="+d+"))?"),A||(v+="(?="+h+"|"+d+")")}return new RegExp(v,l(r))}(f(e,r),t,r)}function d(e,t,r){return e instanceof RegExp?function(e,t){if(!t)return e;var r=e.source.match(/\((?!\?)/g);if(r)for(var n=0;n<r.length;n++)t.push({name:n,prefix:"",suffix:"",modifier:"",pattern:""});return e}(e,t):Array.isArray(e)?function(e,t,r){var n=e.map((function(e){return d(e,t,r).source}));return new RegExp("(?:"+n.join("|")+")",l(r))}(e,t,r):p(e,t,r)}const h="undefined"!=typeof uniCloud,v=()=>!1,y=()=>!0;function w(e){if("string"==typeof e){const t=d(e,[],{end:!1});return t.global&&(t.lastIndex=0),e=>t.test(e.event.action)}if(e instanceof RegExp)return t=>(e.global&&(e.lastIndex=0),e.test(t.event.action));if("function"==typeof e)return e;if(Array.isArray(e)){const t=e.map(e=>w(e));return e=>t.some(t=>t(e))}throw new Error("match/ignore pattern must be RegExp, Array or String, but got "+e)}class m{constructor(e){this.ctx=e,this.service=e.service,this.db=e.db,this.httpclient=e.httpclient}}var x=function(e){if(!Array.isArray(e))throw new TypeError("Middleware stack must be an array!");for(const t of e)if("function"!=typeof t)throw new TypeError("Middleware must be composed of functions!");return function(t,r){let n=-1;return function i(o){if(o<=n)return Promise.reject(new Error("next() called multiple times"));n=o;let s=e[o];o===e.length&&(s=r);if(!s)return Promise.resolve();try{return Promise.resolve(s(t,i.bind(null,o+1)))}catch(e){return Promise.reject(e)}}(0)}};class E extends r.EventEmitter{constructor(e){super(),this.middleware=[];const{baseDir:t,middleware:r}=e;this.serviceDir=o.default.resolve(t,"service"),this.controllerDir=o.default.resolve(t,"controller"),this.initMiddleware(r)}initMiddleware(e){Array.isArray(e)&&e.forEach(([e,t])=>{this.use(e,t)})}wrapMiddleware(e,t){const r=function(e){if(!e)return y;const{enable:t,match:r,ignore:n}=e;if(!1===t)return v;if(!r&&!n)return y;if(r&&n)throw new Error("options.match and options.ignore can not both present");const i=w(r||n);return function(e){const t=i(e);return r?t:!t}}(t),n=(t,n)=>r(t)?e(t,n):n();return n._name=e._name||e.name,n}use(e,t){if("function"!=typeof e)throw new TypeError("middleware must be a function");return this.middleware.push(this.wrapMiddleware(e,t)),this}async serve(e,t){const r=function(e,t,r){const n={state:{},event:e,context:t};return n.service=u(r,n),h&&(n.db=uniCloud.database(),n.httpclient=uniCloud.httpclient),n}(e||h&&uniCloud.$args,t||h&&uniCloud.$ctx,this.serviceDir),n=this.controller(r),i=x(this.middleware.concat(n));return new Promise((e,t)=>{i(r).then(()=>{e(this.respond(r))}).catch(t)})}controller(e){const t=e.event.action;if(!t)throw new Error("action is required");if(-1===t.indexOf("/"))throw new Error('action must contain "/"');const r=t.lastIndexOf("/"),n=t.substr(r+1),i=o.default.join(this.controllerDir,t.substr(0,r));let s=require(i);s=s.default||s;const a=new s(e),u=a[n];if("function"!=typeof u)throw new Error(`${i}.${n} is not a function`);return u.bind(a)}respond(e){return e.body}}const g=m,b=m;exports.Controller=b,exports.Router=E,exports.Service=g;
